<p-dialog [closeOnEscape]="true" [position]="'right'" [header]="titleDialog" styleClass="p-fluid w-83" [modal]="true" [(visible)]="isShowDialog" (onHide)="hideDialog()">
  <ng-template pTemplate="content">
    <p-steps [model]="stepItems" [activeIndex]="stepIndex"></p-steps>

    <ng-container *ngIf="stepIndex === 0">
      <p-card>
        <ng-template pTemplate="content">
          <form [formGroup]="shippingMarkForm">
            <div class="p-field">
              <label for="shippingRequests" class="control-label">Shipping Requests</label><span class="p-invalid"> *</span>
              <p-dropdown
                [ngClass]="{ 'ng-dirty': shippingRequestControl.invalid && (shippingRequestControl.dirty || shippingRequestControl.touched) }"
                [options]="selecteShippingRequestItems"
                [formControl]="shippingRequestControl"
                (onChange)="handleSelectedShippingRequest($event.value)"
                defaultLabel="Select Shipping Requests"
                appendTo="body"
                id="shippingRequests"
                autoDisplayFirst="false"
                placeholder="Shipping Request"
              >
              </p-dropdown>
              <ng-container *ngIf="shippingRequestControl.invalid && (shippingRequestControl.dirty || shippingRequestControl.touched)">
                <small class="p-invalid p-error">Please select Shipping Request</small>
              </ng-container>
            </div>

            <div class="p-field">
              <label for="notes">Notes</label>
              <textarea id="notes" pInputTextarea [rows]="3" [formControl]="notesControl"></textarea>
            </div>
          </form>
        </ng-template>

        <ng-template pTemplate="footer">
          <div class="p-grid p-nogutter p-justify-between">
            <p-button styleClass="p-button-text" label="Cancel" (onClick)="hideDialog()" iconPos="left" icon="pi pi-times"></p-button>
            <p-button
              [disabled]="shippingMarkForm.invalid"
              styleClass="p-button-text"
              label="Next"
              (onClick)="nextPage(stepIndex)"
              icon="pi pi-angle-right"
              iconPos="right"
            ></p-button>
          </div>
        </ng-template>
      </p-card>
    </ng-container>

    <ng-container *ngIf="stepIndex === 1">
      <p-card>
        <ng-template pTemplate="content">
          <ng-container *ngIf="isEnableScan; else disabledScan">
            <div class="p-fluid p-grid">
              <div class="p-field p-col-12">
                <span class="p-input-icon-right">
                  <i class="pi pi-spin pi-spinner" *ngIf="isShowLoading"></i>
                  <input type="text" pInputText [formControl]="receivedMarkPrintingControl" />
                </span>
              </div>
            </div>
          </ng-container>
          <ng-template #disabledScan>
            <p-toolbar styleClass="p-mb-4">
              <ng-template pTemplate="left"></ng-template>
              <ng-template pTemplate="right">
                <button label="Scan Received Mark" pButton pRipple type="button" icon="pi pi-wifi" class="p-button-help" (click)="enableScan()"></button>
              </ng-template>
            </p-toolbar>
          </ng-template>

          <p-table dataKey="product.id" [value]="shippingMarkShippings">
            <ng-template pTemplate="header" let-columns>
              <tr>
                <th class="p-text-center">Shipping Request</th>
                <th class="p-text-center">Product Number</th>
                <th class="p-text-center">Description</th>
                <th class="p-text-center">Qty/ Pkg</th>
                <th class="p-text-center">Quantity</th>
                <th class="p-text-center">Quantity of Received Marks</th>
                <th style="width: 10rem"></th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item let-expanded="expanded">
              <tr [pEditableRow]="item">
                <td>{{ item?.shippingRequest?.identifier }}</td>

                <td>
                  {{ item?.product?.productNumber }}
                </td>

                <td>
                  {{ item?.product?.productName }}
                </td>

                <td class="p-text-center">
                  {{ item?.product?.qtyPerPackage }}
                </td>

                <td class="p-text-center">
                  {{ item?.quantity | number }}
                </td>

                <td class="p-text-center">
                  {{ calculateQuantityReceivedMark(item['selectedReceivedMarks']) | number }} - {{ item['selectedReceivedMarks'].length | number }} packages
                </td>

                <td class="p-text-center">
                  <button
                    type="button"
                    pButton
                    pRipple
                    [pRowToggler]="item"
                    class="p-button-text p-button-rounded p-button-plain"
                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                  ></button>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="rowexpansion" let-item>
              <tr>
                <td colspan="7">
                  <div>
                    <p-table
                      class="shipping-mark-create__expaned-table"
                      [(selection)]="item['selectedReceivedMarks']"
                      selectionMode="multiple"
                      [value]="item.product.receivedMarkPrintings"
                      dataKey="id"
                    >
                      <ng-template pTemplate="header">
                        <tr>
                          <th class="p-text-center">Package Received</th>
                          <th class="p-text-center">Quantity</th>
                          <th class="p-text-center">Status</th>
                          <th style="width: 4rem">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                          </th>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="body" let-receivedMarkPrinting>
                        <tr>
                          <td class="p-text-center">{{ receivedMarkPrinting.identifier }}</td>
                          <td class="p-text-center">{{ receivedMarkPrinting.quantity }}</td>
                          <td class="p-text-center">{{ receivedMarkPrinting.status }}</td>
                          <td>
                            <p-tableCheckbox [value]="receivedMarkPrinting"></p-tableCheckbox>
                          </td>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="emptymessage">
                        <tr>
                          <td colspan="4" class="p-text-center">There are no recieved mark printing for this product yet.</td>
                        </tr>
                      </ng-template>
                    </p-table>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </ng-template>

        <ng-template pTemplate="footer">
          <div class="p-grid p-nogutter p-justify-between">
            <p-button styleClass="p-button-text" label="Back" (onClick)="prevPage()" iconPos="left" icon="pi pi-angle-left"></p-button>
            <p-button
              styleClass="p-button-text"
              label="Next"
              (onClick)="nextPage(stepIndex)"
              icon="pi pi-angle-right"
              iconPos="right"
            ></p-button>
          </div>
        </ng-template>
      </p-card>
    </ng-container>

    <ng-container *ngIf="stepIndex === 2">
      <p-card>
        <ng-template pTemplate="content">
          <p-table dataKey="id" [value]="dataSummary">
            <ng-template pTemplate="header" let-columns>
              <tr>
                <th class="p-text-center">Product Number</th>
                <th class="p-text-center">Description</th>
                <th class="p-text-center">Qty/ Pkg</th>
                <th class="p-text-center">Quantity</th>
                <th class="p-text-center">Total Received Marks Quantity</th>
                <th class="p-text-center">Total Shipping Marks (expect)</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item>
              <tr>
                <td>
                  {{ item?.productNumber }}
                </td>
                <td>
                  {{ item?.productName }}
                </td>
                <td>
                  {{ item?.qtyPerPackage }}
                </td>
                <td class="p-text-center">
                  {{ item?.quantity | number }}
                </td>
                <td class="p-text-center" [ngClass]="{ 'shipping-mark-create__warning-text': item?.totalReceivedMarks !== item?.quantity }">
                  {{ item?.totalReceivedMarks | number }}
                </td>
                <td class="p-text-center">
                  {{ item?.totalShippingMarks | number }}
                </td>
              </tr>
            </ng-template>
          </p-table>
        </ng-template>
        <ng-template pTemplate="footer">
          <div class="p-grid p-nogutter p-justify-between">
            <p-button styleClass="p-button-text" label="Back" (onClick)="prevPage()" iconPos="left" icon="pi pi-angle-left"></p-button>
            <p-button [disabled]="shippingMarkForm.invalid" styleClass="p-button-text" label="Complete" (onClick)="onSubmit()" icon="pi pi-angle-right" iconPos="right"></p-button>
          </div>
        </ng-template>
      </p-card>
    </ng-container>
  </ng-template>
</p-dialog>
